<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>CamÃ©ra live NB + Overlay (1080Ã—1920)</title>
  <style>
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #container { position:relative; width:100%; height:100vh; overflow:hidden; }
    #canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      touch-action:none;
      z-index:1;
      pointer-events:none;
      background:black;
      display:block;
    }
    #controls {
      position:absolute;
      left:50%;
      bottom:12px;
      transform:translateX(-50%);
      z-index:40;
      width:92%;
      max-width:420px;
      padding:10px;
      background:rgba(0,0,0,0.45);
      border-radius:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      -webkit-tap-highlight-color: transparent;
      pointer-events:auto;
    }
    #threshold { width:100%; }
    #capture {
      width:100%;
      padding:10px;
      font-size:18px;
      border-radius:8px;
      border:0;
      background:#1db954;
      color:white;
      cursor:pointer;
      -webkit-user-select:none;
    }
    #result {
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      z-index:60;
      background:black;
      display:none;
      touch-action:none;
    }
    #topInfo {
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      z-index:40;
      color:#fff;
      background:rgba(0,0,0,0.25);
      padding:6px 8px;
      border-radius:8px;
      font-size:14px;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" autoplay playsinline muted style="display:none;"></video>
    <canvas id="canvas"></canvas>
    <img id="result" alt="RÃ©sultat" />
    <div id="topInfo">Seuil : <span id="thresholdValue">128</span></div>
    <div id="controls" aria-hidden="false">
      <input id="threshold" type="range" min="0" max="255" value="128" />
      <button id="capture" type="button">ðŸ“¸ Prendre la photo (1080Ã—1920)</button>
    </div>
  </div>

  <script>
    (function(){
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      const threshold = document.getElementById('threshold');
      const thresholdValue = document.getElementById('thresholdValue');
      const captureBtn = document.getElementById('capture');
      const result = document.getElementById('result');

      const overlay = new Image();
      overlay.crossOrigin = "anonymous"; // CORS pour Ã©viter 'tainted canvas'
      overlay.src = "calque.png";
      let overlayReady = false;
      overlay.onload = () => {
        overlayReady = true;
        console.log("Overlay chargÃ©");
      };
      overlay.onerror = () => {
        console.warn("Overlay non trouvÃ©, traitement overlay dÃ©sactivÃ©.");
        overlayReady = false;
      };

      const captureCanvas = document.createElement('canvas');
      const captureCtx = captureCanvas.getContext('2d', { willReadFrequently: true });
      captureCanvas.width = 1080;
      captureCanvas.height = 1920;

      let playing = false;
      let videoWidth = 1280, videoHeight = 720;

      function updateCanvasSize() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          return video.play();
        })
        .then(() => {
          video.addEventListener('loadedmetadata', () => {
            videoWidth = video.videoWidth;
            videoHeight = video.videoHeight;
            updateCanvasSize();
            playing = true;
            requestAnimationFrame(drawFrame);
          }, { once: true });
        })
        .catch(err => {
          console.error("AccÃ¨s camÃ©ra impossible :", err);
          alert("Impossible d'accÃ©der Ã  la camÃ©ra : " + (err?.message || err));
        });

      function drawFrame() {
        if (!playing) return;

        // Assure que la vidÃ©o est prÃªte
        if (video.readyState >= 2) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const t = parseInt(threshold.value, 10) || 128;
          thresholdValue.textContent = t;

          try {
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const d = img.data;
            for(let i = 0; i < d.length; i += 4){
              const avg = (d[i] + d[i+1] + d[i+2]) / 3;
              const v = avg > t ? 255 : 0;
              d[i] = d[i+1] = d[i+2] = v;
            }
            ctx.putImageData(img, 0, 0);
          } catch(e) {}

          // Dessin du calque uniquement si prÃªt
          if (overlayReady) {
            try {
              ctx.drawImage(overlay, 0, 0, canvas.width, canvas.height);
            } catch(e) {}
          }
        }

        requestAnimationFrame(drawFrame);
      }

      function captureImage() {
        const t = parseInt(threshold.value, 10) || 128;
        const videoRatio = videoWidth / videoHeight;
        const targetRatio = 1080 / 1920;
        let sx, sy, sw, sh;

        if (videoRatio > targetRatio) {
          sh = videoHeight;
          sw = sh * targetRatio;
          sx = (videoWidth - sw) / 2;
          sy = 0;
        } else {
          sw = videoWidth;
          sh = sw / targetRatio;
          sx = 0;
          sy = (videoHeight - sh) / 2;
        }

        try {
          captureCtx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
          captureCtx.drawImage(video, sx, sy, sw, sh, 0, 0, captureCanvas.width, captureCanvas.height);
        } catch(e){
          console.error("Erreur drawImage pour capture :", e);
        }

        try {
          const img = captureCtx.getImageData(0, 0, captureCanvas.width, captureCanvas.height);
          const d = img.data;
          for(let i = 0; i < d.length; i += 4){
            const avg = (d[i] + d[i+1] + d[i+2]) / 3;
            const v = avg > t ? 255 : 0;
            d[i] = d[i+1] = d[i+2] = v;
          }
          captureCtx.putImageData(img, 0, 0);
        } catch(e) {
          console.error("getImageData failed on capture :", e);
          alert("Impossible d'appliquer le filtre. VÃ©rifie que calque.png est bien prÃ©sent et servi localement.");
        }

        if (overlayReady) {
          try {
            captureCtx.drawImage(overlay, 0, 0, captureCanvas.width, captureCanvas.height);
          } catch(e) {
            console.warn("Overlay non appliquÃ© :", e);
          }
        }

        // Flash effet (optionnel visuel)
        flashEffect();

        captureCanvas.toBlob(blob => {
          if (!blob) {
            alert("Erreur lors de la gÃ©nÃ©ration de l'image.");
            return;
          }
          const url = URL.createObjectURL(blob);
          result.src = url;
          result.style.display = "block";

          const now = new Date();
          const fn = `photo_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.png`;
          const a = document.createElement('a');
          a.href = url;
          a.download = fn;
          document.body.appendChild(a);
          a.click();
          a.remove();

          setTimeout(() => URL.revokeObjectURL(url), 60000);
        }, 'image/png');
      }

      function flashEffect() {
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.inset = 0;
        flash.style.background = 'white';
        flash.style.opacity = 0.8;
        flash.style.zIndex = 100;
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 150);
      }

      captureBtn.addEventListener('click', e => {
        e.preventDefault();
        captureImage();
      });

      result.addEventListener('click', () => {
        try { URL.revokeObjectURL(result.src); } catch(e) {}
        result.style.display = "none";
        result.src = "";
      });

      threshold.addEventListener('input', () => {
        thresholdValue.textContent = threshold.value;
      });

      window.addEventListener('resize', updateCanvasSize);
    })();
  </script>
</body>
</html>
